<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Yigong Hu">
<meta name="dcterms.date" content="2023-03-22">

<title>Yigong Hu’s Supplemental Materials for GIScience - Introducing a General Framework for Locally Weighted Spatial Modelling Based on Density Regression</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Yigong Hu’s Supplemental Materials for GIScience</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/HPDell/"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Introducing a General Framework for Locally Weighted Spatial Modelling Based on Density Regression</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Yigong Hu </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 22, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#installation" id="toc-installation" class="nav-link active" data-scroll-target="#installation">Installation</a></li>
  <li><a href="#usage" id="toc-usage" class="nav-link" data-scroll-target="#usage">Usage</a></li>
  <li><a href="#experiments" id="toc-experiments" class="nav-link" data-scroll-target="#experiments">Experiments</a>
  <ul class="collapse">
  <li><a href="#two-dimensional-data" id="toc-two-dimensional-data" class="nav-link" data-scroll-target="#two-dimensional-data">Two-dimensional Data</a>
  <ul class="collapse">
  <li><a href="#data-generating" id="toc-data-generating" class="nav-link" data-scroll-target="#data-generating">Data Generating</a></li>
  <li><a href="#model-dlsm" id="toc-model-dlsm" class="nav-link" data-scroll-target="#model-dlsm">Model: DLSM</a></li>
  <li><a href="#model-gwr" id="toc-model-gwr" class="nav-link" data-scroll-target="#model-gwr">Model: GWR</a></li>
  <li><a href="#analysis-of-coefficient-estimates" id="toc-analysis-of-coefficient-estimates" class="nav-link" data-scroll-target="#analysis-of-coefficient-estimates">Analysis of Coefficient Estimates</a></li>
  <li><a href="#local-polynomial-estimator" id="toc-local-polynomial-estimator" class="nav-link" data-scroll-target="#local-polynomial-estimator">Local Polynomial Estimator</a></li>
  </ul></li>
  <li><a href="#three-dimensional-data" id="toc-three-dimensional-data" class="nav-link" data-scroll-target="#three-dimensional-data">Three-dimensional Data</a>
  <ul class="collapse">
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a></li>
  <li><a href="#model-dlsm-1" id="toc-model-dlsm-1" class="nav-link" data-scroll-target="#model-dlsm-1">Model: DLSM</a></li>
  <li><a href="#model-gtwr" id="toc-model-gtwr" class="nav-link" data-scroll-target="#model-gtwr">Model: GTWR</a></li>
  <li><a href="#analysis" id="toc-analysis" class="nav-link" data-scroll-target="#analysis">Analysis</a></li>
  </ul></li>
  <li><a href="#four-dimensional-data" id="toc-four-dimensional-data" class="nav-link" data-scroll-target="#four-dimensional-data">Four-dimensional Data</a>
  <ul class="collapse">
  <li><a href="#data-generating-1" id="toc-data-generating-1" class="nav-link" data-scroll-target="#data-generating-1">Data Generating</a></li>
  <li><a href="#model-dlsm-2" id="toc-model-dlsm-2" class="nav-link" data-scroll-target="#model-dlsm-2">Model: DLSM</a></li>
  <li><a href="#model-gwr-1" id="toc-model-gwr-1" class="nav-link" data-scroll-target="#model-gwr-1">Model: GWR</a></li>
  <li><a href="#analysis-1" id="toc-analysis-1" class="nav-link" data-scroll-target="#analysis-1">Analysis</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>In this document, I’m going to show codes of simulation experiments and their results demonstrated in the short paper <em>Introducing a General Framework for Locally Weighted Spatial Modelling Based on Density Regression</em>. This paper mainly talks about a density-based local spatial modelling (DLSM) method, which was originally named as “geographically weighted density regression (GWDR)”. In the following parts, we don’t distinguish these two terms.</p>
<p>In addition to show reproducable code of experiments shown in the paper, We are going to describe a bit how to install and use this model.</p>
<section id="installation" class="level1">
<h1>Installation</h1>
<p>The R implementation of GWDR is in the unpublished <a href="https://github.com/GWmodel-Lab/GWmodel2/tree/feature-gctwr"><code>feature-gctwr</code> branch</a> of package <a href="https://cran.r-project.org/web/packages/GWmodel/index.html"><strong>GWmodel</strong></a>. To use it, please clone this repositry, switch to this branch, and install this package manually.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/GWmodel-Lab/GWmodel2.git GWmodel</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> GWmodel</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> switch feature-gctwr</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> CMD INSTALL GWmodel</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please install <a href="https://cran.r-project.org/bin/windows/Rtools/">Rtools</a> if you are using Windows platforms.</p>
</div>
</div>
<p>When all packages are ready, please go on to the next section.</p>
</section>
<section id="usage" class="level1">
<h1>Usage</h1>
<p>The function <code>gwdr()</code> can calibrate a DLSM model according to given formula, data, and other settings.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>gwdr <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    formula, data,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    coords, kernel.list, <span class="at">solver =</span> <span class="st">"kernel.smooth"</span>, ...</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>) { ... }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It accepts several parameters. Besides the <code>formula</code> and <code>data</code> arguments that are constant with other regression models in R, three additional key arguments are needed:</p>
<dl>
<dt><code>coords</code></dt>
<dd>
Coordinates to uniquely locate every sample. Coordinates may not only geographical positions, but also positions in other dimensions. For example, coordinates of spatio-temporal data are geographical positions and the timestamp; and coordinates of flow data can consist of the geographical positions of origin points, flows’ directions, and flows’ length.
</dd>
<dt><code>kernel.list</code></dt>
<dd>
A list of kernel settings for every dimension. Each item is a full specification of kernel function (including bandwidth) for a dimension, i.e., a column in <code>coords</code>. It usually has three elements in each item: bandwidth value, kernel name, and adaptive or fixed. There is a function <code>gwdr.make.kernel()</code> that would be helpful in creating elements in <code>kernel.list</code>.
</dd>
<dt><code>solver</code></dt>
<dd>
The name of favored density estimation method. By default, its <code>"kernel.smooth"</code> referring the kernel smooth estimation. This estimation method is the same as ordinary GWR-family models, like basic GWR and GTWR. Currently, there is another option <code>"local.poly"</code> for local polynomial estimation. This method is better at eliminating boundary effects to produce more accurate estimates in the area near to boundaries. The additional parameter <code>...</code> will be passed to the corresponding solver function.
</dd>
</dl>
<p>The bandwidth values in <code>kernel.list</code> would significantly affect results. If best values are unknow, there is a function <code>gwdr.bandwidth.optimize()</code> to obtain the optimized bandwidth values.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>gwdr.bandwidth.optimize <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    formula, data, coords, kernel.list,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimize.method =</span> gwdr.bandwidth.optimize.cv,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">solver =</span> <span class="st">"kernel.smooth"</span>, ...</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>) { ... }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The former four arguments and <code>solver</code> are the same as those in <code>gwdr()</code>. The argument <code>optimize.method</code> is used to specify optimization criterion, i.e., Cross Validation (CV) or Akaike Information Criterion (AIC). The former one is quicker while the latter one could avoid overfitting. Note that the underlying algorithm is the Nelder-Meed algorithm, which requires initial values of bandwidths. Usually, <span class="math inline">\(0.618\)</span> is good for adaptive bandwidths.</p>
</section>
<section id="experiments" class="level1">
<h1>Experiments</h1>
<p>In the following codes, the following packages are also required:</p>
<ul>
<li><a href="https://cran.r-project.org/web/packages/tidyverse/index.html"><strong>tidyverse</strong></a></li>
<li><a href="https://cran.r-project.org/web/packages/ggpubr/index.html"><strong>ggpubr</strong></a></li>
<li><a href="https://cran.r-project.org/web/packages/ggpmisc/index.html"><strong>ggpmisc</strong></a></li>
<li><a href="https://cran.r-project.org/web/packages/sf/index.html"><strong>sf</strong></a></li>
<li><a href="https://cran.r-project.org/web/packages/Metrics/index.html"><strong>Metrics</strong></a></li>
<li><a href="https://cran.r-project.org/web/packages/reshape2/index.html"><strong>reshape2</strong></a></li>
</ul>
<p>Please install and load them too.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-1_abacabc414b370572e85be9b53dba622">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GWmodel)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpmisc)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Metrics)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We carried out three experiments, generating simulation data sets to demonstrate how DLSM works. We also calibrated a corresponding GWR-family model in each experiment to provide a comparison. In the experiments, based on the coefficient estimates we examine the proximity to their actual values by making scatter plot with regression lines and calculate their RMSE and MAE criterions defined by <span class="math display">\[
\begin{aligned}
\mathrm{RMSE} &amp;= \sum_{i=1}^n \left(r_i-e_i\right)^2 \\
\mathrm{MAE} &amp;= \sum_{i=1}^n \left|r_i-e_i\right|
\end{aligned}
\]</span> where <span class="math inline">\(n\)</span> is the number of estimates, <span class="math inline">\(e_i\)</span> is the <span class="math inline">\(i\)</span>-th estimate, and <span class="math inline">\(r_i\)</span> is the corresponding real value.</p>
<section id="two-dimensional-data" class="level2">
<h2 class="anchored" data-anchor-id="two-dimensional-data">Two-dimensional Data</h2>
<section id="data-generating" class="level3">
<h3 class="anchored" data-anchor-id="data-generating">Data Generating</h3>
<p>Data of two dimensions (equalivent to normal geographic data) are generated by the following codes.</p>
<div class="cell" data-hash="index_cache/html/d2-datagen_f1dbc85ddd913166d0b186a3ac1822f0">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>generate_data_d2 <span class="ot">&lt;-</span> <span class="cf">function</span> (size) {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">11</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  U1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> size, <span class="at">mean =</span> <span class="dv">3000</span>, <span class="at">sd =</span> <span class="dv">100</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">12</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  U2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> size, <span class="at">mean =</span> <span class="dv">3000</span>, <span class="at">sd =</span> <span class="dv">100</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">21</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  x1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> size, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">22</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> size, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">23</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  x3 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> size, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  U1c <span class="ot">&lt;-</span> (U1 <span class="sc">-</span> <span class="dv">3000</span>) <span class="sc">/</span> <span class="dv">100</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  U2c <span class="ot">&lt;-</span> (U2 <span class="sc">-</span> <span class="dv">3000</span>) <span class="sc">/</span> <span class="dv">100</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  b0 <span class="ot">&lt;-</span> U1c <span class="sc">+</span> U2c<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  b1 <span class="ot">&lt;-</span> U1c <span class="sc">+</span> U2c<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="dv">10</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  b2 <span class="ot">&lt;-</span> U1c <span class="sc">+</span> (U2c <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  b3 <span class="ot">&lt;-</span> U1c <span class="sc">+</span> U2c<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> U2c</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> b0 <span class="sc">+</span> b1 <span class="sc">*</span> x1 <span class="sc">+</span> b2 <span class="sc">*</span> x2 <span class="sc">+</span> b3 <span class="sc">*</span> x3 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="at">n =</span> size, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">x1 =</span> x1, <span class="at">x2 =</span> x2, <span class="at">x3 =</span> x3),</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">coords =</span> <span class="fu">cbind</span>(<span class="at">U1 =</span> U1, <span class="at">U2 =</span> U2),</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta =</span> <span class="fu">data.frame</span>(<span class="at">Intercept =</span> b0, <span class="at">x1 =</span> b1, <span class="at">x2 =</span> b2, <span class="at">x3 =</span> b3)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>data_d2 <span class="ot">&lt;-</span> <span class="fu">generate_data_d2</span>(<span class="dv">5000</span>)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(data_d2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ data  :'data.frame': 5000 obs. of  4 variables:
  ..$ y : num [1:5000] 7.06 7.66 15.01 -14.52 37.88 ...
  ..$ x1: num [1:5000] 0.793 0.522 1.746 -1.271 2.197 ...
  ..$ x2: num [1:5000] -0.512 2.485 1.008 0.293 -0.209 ...
  ..$ x3: num [1:5000] 0.193 -0.435 0.913 1.793 0.997 ...
 $ coords: num [1:5000, 1:2] 2941 3003 2848 2864 3118 ...
  ..- attr(*, "dimnames")=List of 2
  .. ..$ : NULL
  .. ..$ : chr [1:2] "U1" "U2"
 $ beta  :'data.frame': 5000 obs. of  4 variables:
  ..$ Intercept: num [1:5000] 1.601 2.514 -0.601 -0.516 5.169 ...
  ..$ x1       : num [1:5000] 11.6 12.51 9.4 9.48 15.17 ...
  ..$ x2       : num [1:5000] 5.56 0.36 2.31 2.32 10.16 ...
  ..$ x3       : num [1:5000] -1.36 5.67 -2.51 -2.36 1.17 ...</code></pre>
</div>
</div>
<p>Then, calibrate two models: DLSM and basic GWR.</p>
</section>
<section id="model-dlsm" class="level3">
<h3 class="anchored" data-anchor-id="model-dlsm">Model: DLSM</h3>
<p>Firstly, we need to get a set of optimized bandwidth, each element for a dimension.</p>
<div class="cell" data-hash="index_cache/html/d2-gwdr-bw_5825be8ac289c8bdde459a15bfb4e69b">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>d2_gwdr_bw <span class="ot">&lt;-</span> <span class="fu">gwdr.bandwidth.optimize</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_d2<span class="sc">$</span>data,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">coords =</span> data_d2<span class="sc">$</span>coords,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">kernel.list =</span> <span class="fu">list</span>(</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">gwdr.make.kernel</span>(<span class="fl">0.618</span>, <span class="at">kernel =</span> <span class="st">"gaussian"</span>, <span class="at">adaptive =</span> T),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">gwdr.make.kernel</span>(<span class="fl">0.618</span>, <span class="at">kernel =</span> <span class="st">"gaussian"</span>, <span class="at">adaptive =</span> T)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimize.method =</span> gwdr.bandwidth.optimize.aic</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>d2_gwdr_bw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[[1]][[1]]
[1] "gaussian"

[[1]][[2]]
[1] 0.2243633

[[1]][[3]]
[1] TRUE


[[2]]
[[2]][[1]]
[1] "gaussian"

[[2]][[2]]
[1] 0.008293663

[[2]][[3]]
[1] TRUE</code></pre>
</div>
</div>
<p>Then, calibrate a GWDR model with this bandwidth set.</p>
<div class="cell" data-hash="index_cache/html/d2-gwdr-model_382730be7cb33e059f4eb66778129d3f">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>d2_gwdr <span class="ot">&lt;-</span> <span class="fu">gwdr</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_d2<span class="sc">$</span>data,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">coords =</span> data_d2<span class="sc">$</span>coords,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">kernel.list =</span> d2_gwdr_bw</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>d2_gwdr<span class="sc">$</span>diagnostic</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$R2
[1] 0.9890828

$R2.adj
[1] 0.9838953

$AICc
[1] 19695.4</code></pre>
</div>
</div>
</section>
<section id="model-gwr" class="level3">
<h3 class="anchored" data-anchor-id="model-gwr">Model: GWR</h3>
<p>The GWR model for this data set can be calibrated with the following code.</p>
<div class="cell" data-hash="index_cache/html/d2-gwr-model_1a9e395e6b3be7ed1fb0e6e03738ec51">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>d2sp <span class="ot">&lt;-</span> data_d2<span class="sc">$</span>data</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(d2sp) <span class="ot">&lt;-</span> data_d2<span class="sc">$</span>coords</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>d2_gwr_bw <span class="ot">&lt;-</span> <span class="fu">bw.gwr</span>(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> d2sp,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">adaptive =</span> T,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">approach =</span> <span class="st">"AIC"</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">kernel =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">longlat =</span> F</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Take a cup of tea and have a break, it will take a few minutes.
          -----A kind suggestion from GWmodel development group
Adaptive bandwidth (number of nearest neighbours): 3097 AICc value: 28564.75 
Adaptive bandwidth (number of nearest neighbours): 1922 AICc value: 27977.58 
Adaptive bandwidth (number of nearest neighbours): 1194 AICc value: 27333.17 
Adaptive bandwidth (number of nearest neighbours): 746 AICc value: 26614.68 
Adaptive bandwidth (number of nearest neighbours): 467 AICc value: 25821.45 
Adaptive bandwidth (number of nearest neighbours): 296 AICc value: 24986.24 
Adaptive bandwidth (number of nearest neighbours): 189 AICc value: 24106.2 
Adaptive bandwidth (number of nearest neighbours): 124 AICc value: 23222.91 
Adaptive bandwidth (number of nearest neighbours): 82 AICc value: 22314.04 
Adaptive bandwidth (number of nearest neighbours): 58 AICc value: 21556.79 
Adaptive bandwidth (number of nearest neighbours): 41 AICc value: 20825.54 
Adaptive bandwidth (number of nearest neighbours): 32 AICc value: 20268.46 
Adaptive bandwidth (number of nearest neighbours): 25 AICc value: 19794.13 
Adaptive bandwidth (number of nearest neighbours): 22 AICc value: 19582.89 
Adaptive bandwidth (number of nearest neighbours): 19 AICc value: 19302.27 
Adaptive bandwidth (number of nearest neighbours): 18 AICc value: 19213.83 
Adaptive bandwidth (number of nearest neighbours): 16 AICc value: 18980.64 
Adaptive bandwidth (number of nearest neighbours): 16 AICc value: 18980.64 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>d2_gwr <span class="ot">&lt;-</span> <span class="fu">gwr.basic</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> d2sp,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">bw =</span> d2_gwr_bw,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">adaptive =</span> T,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">kernel =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">longlat =</span> F</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>d2_gwr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   ***********************************************************************
   *                       Package   GWmodel                             *
   ***********************************************************************
   Program starts at: 2023-03-27 16:34:17 
   Call:
   gwr.basic(formula = y ~ x1 + x2 + x3, data = d2sp, bw = d2_gwr_bw, 
    kernel = "gaussian", adaptive = T, longlat = F)

   Dependent (y) variable:  y
   Independent variables:  x1 x2 x3
   Number of data points: 5000
   ***********************************************************************
   *                    Results of Global Regression                     *
   ***********************************************************************

   Call:
    lm(formula = formula, data = data)

   Residuals:
    Min      1Q  Median      3Q     Max 
-41.449  -2.388  -0.283   1.964  35.784 

   Coefficients:
               Estimate Std. Error t value Pr(&gt;|t|)    
   (Intercept)  1.19760    0.06607   18.13   &lt;2e-16 ***
   x1          11.12053    0.06613  168.17   &lt;2e-16 ***
   x2           2.08131    0.06610   31.49   &lt;2e-16 ***
   x3           1.16391    0.06631   17.55   &lt;2e-16 ***

   ---Significance stars
   Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 
   Residual standard error: 4.671 on 4996 degrees of freedom
   Multiple R-squared: 0.8557
   Adjusted R-squared: 0.8556 
   F-statistic:  9874 on 3 and 4996 DF,  p-value: &lt; 2.2e-16 
   ***Extra Diagnostic information
   Residual sum of squares: 108997.5
   Sigma(hat): 4.669928
   AIC:  29608.82
   AICc:  29608.83
   BIC:  24683.99
   ***********************************************************************
   *          Results of Geographically Weighted Regression              *
   ***********************************************************************

   *********************Model calibration information*********************
   Kernel function: gaussian 
   Adaptive bandwidth: 16 (number of nearest neighbours)
   Regression points: the same locations as observations are used.
   Distance metric: Euclidean distance metric is used.

   ****************Summary of GWR coefficient estimates:******************
                   Min.    1st Qu.     Median    3rd Qu.    Max.
   Intercept -2.3010764  0.0021137  0.8763939  1.7517336  6.1792
   x1         7.2879239 10.0490656 10.7414589 11.7858821 16.3170
   x2        -1.9011456  0.2368896  1.3907690  3.0352093 12.2075
   x3        -2.9867908 -0.6821843  0.3649609  2.1155378  9.8081
   ************************Diagnostic information*************************
   Number of data points: 5000 
   Effective number of parameters (2trace(S) - trace(S'S)): 882.6782 
   Effective degrees of freedom (n-2trace(S) + trace(S'S)): 4117.322 
   AICc (GWR book, Fotheringham, et al. 2002, p. 61, eq 2.33): 18980.64 
   AIC (GWR book, Fotheringham, et al. 2002,GWR p. 96, eq. 4.22): 18192.84 
   BIC (GWR book, Fotheringham, et al. 2002,GWR p. 61, eq. 2.34): 17803.57 
   Residual sum of squares: 9849.866 
   R-square value:  0.9869581 
   Adjusted R-square value:  0.9841614 

   ***********************************************************************
   Program stops at: 2023-03-27 16:34:25 </code></pre>
</div>
</div>
<p>Whereas DLSM helps identify anisotropy, it is missing in estimates from a basic GWR model because the only bandwidth value optimized by GWR is 16 nearest neighbours (regardless of direction).</p>
</section>
<section id="analysis-of-coefficient-estimates" class="level3">
<h3 class="anchored" data-anchor-id="analysis-of-coefficient-estimates">Analysis of Coefficient Estimates</h3>
<p>First, we look at the closeness between coefficient estimates and actual values.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-2_7095b71fb1cfe259dd5e498111e4c5da">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(<span class="at">DLSM =</span> d2_gwdr<span class="sc">$</span>betas, <span class="at">GWR =</span> d2_gwr<span class="sc">$</span>SDF<span class="sc">@</span>data) <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">select</span>(.x, Intercept, x1, x2, x3)) <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map2_dfr</span>(., <span class="fu">names</span>(.), <span class="cf">function</span>(model, model_name) {</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">map_dfr</span>(<span class="fu">c</span>(<span class="st">"Intercept"</span>, <span class="st">"x1"</span>, <span class="st">"x2"</span>, <span class="st">"x3"</span>), <span class="sc">~</span> <span class="fu">data.frame</span>(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">Estimated =</span> model[[.x]],</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">Real =</span> data_d2<span class="sc">$</span>beta[[.x]],</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">Coefficient =</span> .x</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">.id =</span> <span class="st">"Model"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Real, <span class="at">y =</span> Estimated)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"darkgreen"</span>) <span class="sc">+</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_poly_eq</span>() <span class="sc">+</span> <span class="fu">stat_poly_line</span>() <span class="sc">+</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="at">rows =</span> <span class="fu">vars</span>(Model), <span class="at">cols =</span> <span class="fu">vars</span>(Coefficient)) <span class="sc">+</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>() <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Then, we look at the RMSE and MAE criterions.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-3_2c3fe85e0367441c2fd6767476fb05d5">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(<span class="at">DLSM =</span> d2_gwdr<span class="sc">$</span>betas, <span class="at">GWR =</span> d2_gwr<span class="sc">$</span>SDF<span class="sc">@</span>data) <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">select</span>(.x, Intercept, x1, x2, x3)) <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map2_dfr</span>(., <span class="fu">names</span>(.), <span class="cf">function</span>(model, model_name) {</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">map_dfr</span>(<span class="fu">c</span>(<span class="st">"Intercept"</span>, <span class="st">"x1"</span>, <span class="st">"x2"</span>, <span class="st">"x3"</span>), <span class="sc">~</span> <span class="fu">data.frame</span>(</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">RMSE =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((data_d2<span class="sc">$</span>beta[[.x]] <span class="sc">-</span> model[[.x]])<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">MAE =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(data_d2<span class="sc">$</span>beta[[.x]] <span class="sc">-</span> model[[.x]])),</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">Coefficient =</span> .x</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">.id =</span> <span class="st">"Model"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map_dfr</span>(<span class="fu">c</span>(<span class="st">"RMSE"</span>, <span class="st">"MAE"</span>), <span class="cf">function</span>(i, model) {</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">data.frame</span>(<span class="at">Value =</span> model[[i]],</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>                   <span class="at">Indicator =</span> i,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">Model =</span> model<span class="sc">$</span>Model,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>                   <span class="at">Coefficient =</span> model<span class="sc">$</span>Coefficient)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    }, .) <span class="sc">%&gt;%</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Coefficient, <span class="at">y =</span> Value, <span class="at">fill =</span> Model)) <span class="sc">+</span> </span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">y =</span> Value <span class="sc">+</span> <span class="fl">0.02</span>, <span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">"%.2f"</span>, Value)),</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>              <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="at">cols =</span> <span class="fu">vars</span>(Indicator)) <span class="sc">+</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="local-polynomial-estimator" class="level3">
<h3 class="anchored" data-anchor-id="local-polynomial-estimator">Local Polynomial Estimator</h3>
<p>Coefficient estimates for some points are significantly biased in both DLSM and GWR models. Now let us try the local polynomial kernel estimation method to demonstrate some of its features. We will calibrate a DLSM model with this kernel analyse coefficient estimates in a same way.</p>
<div class="cell" data-hash="index_cache/html/d2-gwdr-model-lp_ef8318aa91d183b40b48690dc3798612">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>d2_gwdr_lp <span class="ot">&lt;-</span> <span class="fu">gwdr</span>(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_d2<span class="sc">$</span>data,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">coords =</span> data_d2<span class="sc">$</span>coords,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">kernel.list =</span> d2_gwdr_bw,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">solver =</span> <span class="st">"local.poly"</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>d2_gwdr<span class="sc">$</span>diagnostic</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$R2
[1] 0.9890828

$R2.adj
[1] 0.9838953

$AICc
[1] 19695.4</code></pre>
</div>
</div>
<p>The following two figures show comparsion between estimates and real values.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-4_1a3b2fddf0f86015a754ce495e661271">
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-4-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Thus, the local polynomial estimator can significantly reduce estimation errors. And the boundary effects are also reduced.</p>
</section>
</section>
<section id="three-dimensional-data" class="level2">
<h2 class="anchored" data-anchor-id="three-dimensional-data">Three-dimensional Data</h2>
<p>In most spatial modelling research, 3D data are usually referred to spatio-temporal data, i.e., data of geographical and temporal coordinates <span class="math inline">\(u,v,t\)</span>. For this type of data, there is a corresponding geographically and temporally weighted regression <span class="citation" data-cites="HuangWu-2010a">(GTWR, <a href="#ref-HuangWu-2010a" role="doc-biblioref">Huang, Wu, and Barry 2010</a>)</span> model. In this experiment, we compare DLSM model with this method.</p>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<p>We created 4 sets of data through similar generation process introduced in the experiment on 2D data, named as <code>compare-gtwr-i.rds</code> where <code>i</code> is a value from 1 to 4. To access these data, please turn to <a href="https://github.com/HPDell/GIScience-Materials/tree/master/posts/DLSM/data">GitHub worktree page</a>.</p>
<div class="cell" data-hash="index_cache/html/d3-data_17f9c20899402ac09a187a097cbd8587">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>d3_data_list <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>), <span class="cf">function</span>(i) {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">readRDS</span>(<span class="fu">sprintf</span>(<span class="st">"data/compare-gtwr-%d.rds"</span>, i))</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the first two data sets, the time coordinates were generated from a normal distributed random variable, i.e., <span class="math inline">\(t \sim N(1619694000, 604800^2)\)</span>. While in the latter two data sets, <span class="math inline">\(t\)</span> was generated from an arithmetic sequence with 1000 elements, a common different of 1, and a first item <span class="math inline">\(t_0\)</span> of <span class="math inline">\(1619694000\)</span>. And the distribution of coefficients on <span class="math inline">\(t\)</span>-axis follows autoregressive time series.</p>
</section>
<section id="model-dlsm-1" class="level3">
<h3 class="anchored" data-anchor-id="model-dlsm-1">Model: DLSM</h3>
<p>The DLSM model can be calibrated with the following codes:</p>
<div class="cell" data-hash="index_cache/html/d3-gwdr_0ce9a2b43a2adb05f83f39c6d4955367">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>d3_gwdr_list <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>), <span class="cf">function</span> (i) {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    d3_data <span class="ot">&lt;-</span> d3_data_list[[i]]</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    coords_range <span class="ot">&lt;-</span> <span class="fu">apply</span>(d3_data<span class="sc">$</span>coord, <span class="dv">2</span>, max) <span class="sc">-</span> <span class="fu">apply</span>(d3_data<span class="sc">$</span>coord, <span class="dv">2</span>, min)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    kernel <span class="ot">&lt;-</span> <span class="fu">gwdr.bandwidth.optimize</span>(</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> d3_data<span class="sc">$</span>data,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">coords =</span> d3_data<span class="sc">$</span>coord,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">kernel.list =</span> <span class="fu">list</span>(</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">gwdr.make.kernel</span>(coords_range[<span class="dv">1</span>] <span class="sc">*</span> <span class="fl">0.618</span>, <span class="at">kernel =</span> <span class="st">"bisquare"</span>, <span class="at">adaptive =</span> <span class="cn">FALSE</span>),</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>            <span class="fu">gwdr.make.kernel</span>(coords_range[<span class="dv">2</span>] <span class="sc">*</span> <span class="fl">0.618</span>, <span class="at">kernel =</span> <span class="st">"bisquare"</span>, <span class="at">adaptive =</span> <span class="cn">FALSE</span>),</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>            <span class="fu">gwdr.make.kernel</span>(coords_range[<span class="dv">3</span>] <span class="sc">*</span> <span class="fl">0.618</span>, <span class="at">kernel =</span> <span class="st">"bisquare"</span>, <span class="at">adaptive =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gwdr</span>(</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3,</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> d3_data<span class="sc">$</span>data,</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">coords =</span> d3_data<span class="sc">$</span>coord,</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">kernel.list =</span> kernel</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-gtwr" class="level3">
<h3 class="anchored" data-anchor-id="model-gtwr">Model: GTWR</h3>
<p>We used the “<a href="https://www.researchgate.net/publication/329518786_GTWR_ADDIN_Valid_till_Dec_31_2022">GTWR ADDIN</a>” for ArcMap <span class="citation" data-cites="gtwr-addin">(<a href="#ref-gtwr-addin" role="doc-biblioref">Huang and Wang 2020</a>)</span> to calibrate GTWR model for all the four data sets. This is because there is a key parameter <span class="math inline">\(\lambda\)</span> in GTWR mdoel which should be optimized according to data, just like the bandwidth. But <code>gtwr()</code> function in <strong>GWmodel</strong> package does not support this process. And this addin has much higher computing performance. Results are stored in the <a href="https://github.com/HPDell/GIScience-Materials/tree/master/posts/DLSM/gtwr_results">GTWR results folder</a>. We can load them with the following codes.</p>
<div class="cell" data-hash="index_cache/html/d3-gtwr_dbca587da732d0b7e43e91d62b99cee9">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>d3_gtwr_list <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>), <span class="cf">function</span>(i) {</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_read</span>(<span class="fu">file.path</span>(<span class="st">"gtwr_results"</span>, <span class="fu">sprintf</span>(<span class="st">"compare-gtwr-%d-gtwr.shp"</span>, i)))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `compare-gtwr-1-gtwr' from data source 
  `C:\Users\rd21411\OneDrive - University of Bristol\Documents\Conferences\2023_GIScience_Materials\posts\DLSM\gtwr_results\compare-gtwr-1-gtwr.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 1000 features and 8 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 2672.301 ymin: 2695.423 xmax: 3369.969 ymax: 3310.724
CRS:           NA
Reading layer `compare-gtwr-2-gtwr' from data source 
  `C:\Users\rd21411\OneDrive - University of Bristol\Documents\Conferences\2023_GIScience_Materials\posts\DLSM\gtwr_results\compare-gtwr-2-gtwr.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 1000 features and 8 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 2672.301 ymin: 2695.423 xmax: 3369.969 ymax: 3310.724
CRS:           NA
Reading layer `compare-gtwr-3-gtwr' from data source 
  `C:\Users\rd21411\OneDrive - University of Bristol\Documents\Conferences\2023_GIScience_Materials\posts\DLSM\gtwr_results\compare-gtwr-3-gtwr.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 1000 features and 8 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 2672.301 ymin: 2695.423 xmax: 3369.969 ymax: 3310.724
CRS:           NA
Reading layer `compare-gtwr-4-gtwr' from data source 
  `C:\Users\rd21411\OneDrive - University of Bristol\Documents\Conferences\2023_GIScience_Materials\posts\DLSM\gtwr_results\compare-gtwr-4-gtwr.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 1000 features and 8 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 2672.301 ymin: 2695.423 xmax: 3369.969 ymax: 3310.724
CRS:           NA</code></pre>
</div>
</div>
</section>
<section id="analysis" class="level3">
<h3 class="anchored" data-anchor-id="analysis">Analysis</h3>
<p>We analyse the performance of these two models based on coefficient estimates and actual values.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-5_7671c04c94e4d581629cfb337dc679e7">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>d3_model_coef <span class="ot">&lt;-</span> <span class="fu">pmap</span>(<span class="fu">list</span>(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">DLSM =</span> d3_gwdr_list,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">GTWR =</span> d3_gtwr_list,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">Real =</span> d3_data_list</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>), <span class="cf">function</span>(DLSM, GTWR, Real) {</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    dlsm_coef_df <span class="ot">&lt;-</span> <span class="fu">select</span>(DLSM<span class="sc">$</span>betas, Intercept, x1, x2, x3) <span class="sc">%&gt;%</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">map2_dfr</span>(., <span class="fu">names</span>(.), <span class="sc">~</span> <span class="fu">data.frame</span>(</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">Model =</span> <span class="st">"DLSM"</span>,</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">Coefficient =</span> .y,</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">Estimate =</span> .x,</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">Real =</span> Real<span class="sc">$</span>beta[[.y]]</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    gtwr_coef_df <span class="ot">&lt;-</span> <span class="fu">rename</span>(GTWR, <span class="at">x1 =</span> C1_x1, <span class="at">x2 =</span> C2_x2, <span class="at">x3 =</span> C3_x3) <span class="sc">%&gt;%</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Intercept, x1, x2, x3) <span class="sc">%&gt;%</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">map2_dfr</span>(., <span class="fu">names</span>(.), <span class="sc">~</span> <span class="fu">data.frame</span>(</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">Model =</span> <span class="st">"GTWR"</span>,</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">Coefficient =</span> .y,</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">Estimate =</span> .x,</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">Real =</span> Real<span class="sc">$</span>beta[[.y]]</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind</span>(dlsm_coef_df, gtwr_coef_df)</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-6_5601041e4862b9b575f09ebb60f9ea2c">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>d3_model_coef <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(<span class="cf">function</span>(item) {</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>        scatter <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(item, <span class="fu">aes</span>(Real, Estimate)) <span class="sc">+</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>            <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>            <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>) <span class="sc">+</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stat_poly_eq</span>(<span class="fu">use_label</span>(<span class="st">"adj.rr.label"</span>)) <span class="sc">+</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">facet_grid</span>(<span class="at">rows =</span> <span class="fu">vars</span>(Coefficient), <span class="at">cols =</span> <span class="fu">vars</span>(Model)) <span class="sc">+</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">coord_fixed</span>() <span class="sc">+</span> <span class="fu">theme_bw</span>()</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        bar <span class="ot">&lt;-</span> item <span class="sc">%&gt;%</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>            <span class="fu">group_by</span>(Coefficient, Model) <span class="sc">%&gt;%</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>            <span class="fu">summarise</span>(<span class="at">RMSE =</span> <span class="fu">rmse</span>(Real, Estimate), <span class="at">MAE =</span> <span class="fu">mae</span>(Real, Estimate)) <span class="sc">%&gt;%</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>            <span class="fu">melt</span>(<span class="at">id.vars =</span> <span class="fu">c</span>(<span class="st">"Coefficient"</span>, <span class="st">"Model"</span>), <span class="at">variable.name =</span> <span class="st">"Indicator"</span>, <span class="at">value.name =</span> <span class="st">"Value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ggplot</span>(<span class="fu">aes</span>(Coefficient, Value, <span class="at">fill =</span> Model)) <span class="sc">+</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>                <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>                <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">"%.2f"</span>, Value)), <span class="at">size =</span> <span class="dv">2</span>,</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>                        <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="dv">1</span>), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>                <span class="fu">facet_grid</span>(<span class="at">rows =</span> <span class="fu">vars</span>(Indicator)) <span class="sc">+</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme_bw</span>()</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggarrange</span>(scatter, bar, <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">%&gt;%</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">walk2</span>(., <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="cf">function</span>(fig, i) {</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">annotate_figure</span>(fig, <span class="at">bottom =</span> <span class="fu">sprintf</span>(<span class="st">"Data set %d"</span>, i)))</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>    })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-6-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-6-3.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-6-4.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>According to the results, DLSM can reduce the mean of absolute estimation error by 10%-50%, especially when coefficients are temporally autocorrelated. The multiple bandwidths attach actual meaning to the parameters <span class="math inline">\(\lambda,\mu\)</span>; they have a real-world correlate, unlike the root of sum of squared meters and seconds (<span class="math inline">\(\sqrt{\mathrm{m}^2+\mathrm{s}^2}\)</span>).</p>
</section>
</section>
<section id="four-dimensional-data" class="level2">
<h2 class="anchored" data-anchor-id="four-dimensional-data">Four-dimensional Data</h2>
<p>Four-dimensional data are not so common in our daily life. But there is an special example — travel flow. Each flow is a directed line consisting of a origin point and destination point. Thus, flow data are also called O-D data. For a 2D coordinate reference system, both the origin point and desitnation point have a 2D coordinates. Totally, there are 4 coordinates to locate a flow. By converting the four positional coordinates to a set of coordinates of origin point <span class="math inline">\((x,y)\)</span>, direction <span class="math inline">\(\theta\)</span>, and flow length <span class="math inline">\(l\)</span>, we will get a space of four dimensions <span class="math inline">\((x,y,\theta,l)\)</span>. The experiment is based on this space.</p>
<section id="data-generating-1" class="level3">
<h3 class="anchored" data-anchor-id="data-generating-1">Data Generating</h3>
<p>Data of four dimensions are generated by the following codes.</p>
<div class="cell" data-hash="index_cache/html/d4-data-gen_bb33226533146fe503162382c36b2ef7">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>generate_data_d4 <span class="ot">&lt;-</span> <span class="cf">function</span> (size) {</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">11</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  U1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> size, <span class="at">mean =</span> <span class="dv">3000</span>, <span class="at">sd =</span> <span class="dv">100</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">12</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  U2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> size, <span class="at">mean =</span> <span class="dv">3000</span>, <span class="at">sd =</span> <span class="dv">100</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  U3 <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="at">n =</span> size, <span class="at">min =</span> <span class="sc">-</span>pi, <span class="at">max =</span> pi)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">14</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  U4 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> size, <span class="at">mean =</span> <span class="dv">4000</span>, <span class="at">sd =</span> <span class="dv">1000</span>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">21</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  x1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> size, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">22</span>)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> size, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">23</span>)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  x3 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> size, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  b0 <span class="ot">&lt;-</span> <span class="fu">scale</span>(((U1 <span class="sc">-</span> <span class="dv">3000</span>)<span class="sc">/</span><span class="dv">100</span>) <span class="sc">+</span> ((U2 <span class="sc">-</span> <span class="dv">3000</span>)<span class="sc">/</span><span class="dv">100</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> ((U4 <span class="sc">-</span> <span class="dv">4000</span>)<span class="sc">/</span><span class="dv">1000</span>)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  b1 <span class="ot">&lt;-</span> <span class="fu">scale</span>(((U1 <span class="sc">-</span> <span class="dv">3000</span>)<span class="sc">/</span><span class="dv">100</span>) <span class="sc">+</span> ((U2 <span class="sc">-</span> <span class="dv">3000</span>)<span class="sc">/</span><span class="dv">100</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> ((U4 <span class="sc">-</span> <span class="dv">4000</span>)<span class="sc">/</span><span class="dv">1000</span>)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  b2 <span class="ot">&lt;-</span> <span class="fu">scale</span>(((U1 <span class="sc">-</span> <span class="dv">3000</span>)<span class="sc">/</span><span class="dv">100</span>) <span class="sc">+</span> <span class="dv">5</span> <span class="sc">*</span> ((U2 <span class="sc">-</span> <span class="dv">3000</span>)<span class="sc">/</span><span class="dv">100</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> ((U4 <span class="sc">-</span> <span class="dv">4000</span>)<span class="sc">/</span><span class="dv">1000</span>)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>  b3 <span class="ot">&lt;-</span> <span class="fu">scale</span>(<span class="sc">-</span>((U1 <span class="sc">-</span> <span class="dv">3000</span>)<span class="sc">/</span><span class="dv">100</span>) <span class="sc">+</span> ((U2 <span class="sc">-</span> <span class="dv">3000</span>)<span class="sc">/</span><span class="dv">100</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> ((U4 <span class="sc">-</span> <span class="dv">4000</span>)<span class="sc">/</span><span class="dv">1000</span>)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> b0 <span class="sc">+</span> b1 <span class="sc">*</span> x1 <span class="sc">+</span> b2 <span class="sc">*</span> x2 <span class="sc">+</span> b3 <span class="sc">*</span>x3 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="at">n =</span> size, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">x1 =</span> x1, <span class="at">x2 =</span> x2, <span class="at">x3 =</span> x3),</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">coords =</span> <span class="fu">cbind</span>(<span class="at">U1 =</span> U1, <span class="at">U2 =</span> U2, <span class="at">U3 =</span> U3, <span class="at">U4 =</span> U4),</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta =</span> <span class="fu">data.frame</span>(<span class="at">Intercept =</span> b0, <span class="at">x1 =</span> b1, <span class="at">x2 =</span> b2, <span class="at">x3 =</span> b3)</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>data_d4 <span class="ot">&lt;-</span> <span class="fu">generate_data_d4</span>(<span class="dv">5000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-dlsm-2" class="level3">
<h3 class="anchored" data-anchor-id="model-dlsm-2">Model: DLSM</h3>
<p>The DLSM model can be calibrated by the following code.</p>
<div class="cell" data-hash="index_cache/html/d4-dlsm-model_ce3a774cf678e9d7c1a6f23d11e7fff1">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>d4_gwdr_bw <span class="ot">&lt;-</span> <span class="fu">gwdr.bandwidth.optimize</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_d4<span class="sc">$</span>data,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">coords =</span> data_d4<span class="sc">$</span>coords,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">kernel.list =</span> <span class="fu">list</span>(</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">gwdr.make.kernel</span>(<span class="fl">0.618</span>, <span class="at">kernel =</span> <span class="st">"bisquare"</span>, <span class="at">adaptive =</span> T),</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">gwdr.make.kernel</span>(<span class="fl">0.618</span>, <span class="at">kernel =</span> <span class="st">"bisquare"</span>, <span class="at">adaptive =</span> T),</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">gwdr.make.kernel</span>(<span class="fl">0.618</span>, <span class="at">kernel =</span> <span class="st">"bisquare"</span>, <span class="at">adaptive =</span> T),</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">gwdr.make.kernel</span>(<span class="fl">0.618</span>, <span class="at">kernel =</span> <span class="st">"bisquare"</span>, <span class="at">adaptive =</span> T)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>d4_gwdr <span class="ot">&lt;-</span> <span class="fu">gwdr</span>(</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3,</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_d4<span class="sc">$</span>data,</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">coords =</span> data_d4<span class="sc">$</span>coords,</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">kernel.list =</span> d4_gwdr_bw</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>d4_gwdr<span class="sc">$</span>diagnostic</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$R2
[1] 0.8242963

$R2.adj
[1] 0.7287304

$AICc
[1] 17255.57</code></pre>
</div>
</div>
</section>
<section id="model-gwr-1" class="level3">
<h3 class="anchored" data-anchor-id="model-gwr-1">Model: GWR</h3>
<p>To calibrate a GWR model, we need to calculate the distance matrix first because <code>gwr.basic()</code> is not able to calculate distances for lines. Distance between two flows <span class="math inline">\(\overrightarrow{O_iD_i}\)</span> and <span class="math inline">\(\overrightarrow{O_jD_j}\)</span> are defined by <span class="citation" data-cites="KordiFotheringham-2016a">Kordi and Fotheringham (<a href="#ref-KordiFotheringham-2016a" role="doc-biblioref">2016</a>)</span>, <span class="math display">\[
d_{ij}=\sqrt{\frac{
    0.5 \times \left[ (O_{ix}-O_{jx})^2 + (O_{iy}-O_{jy})^2 \right] +
    0.5 \times \left[ (D_{ix}-D_{jx})^2 + (D_{iy}-D_{jy})^2 \right]
}{l_i l_j}}
\]</span> where <span class="math inline">\((O_{ix},O_{iy})\)</span> is the coordinate of <span class="math inline">\(O_i\)</span>, <span class="math inline">\((O_{jx},O_{jy})\)</span> is the coordinate of <span class="math inline">\(O_j\)</span>, <span class="math inline">\((D_{ix},D_{iy})\)</span> is the coordinate of <span class="math inline">\(D_i\)</span>, <span class="math inline">\((D_{jx},D_{jy})\)</span> is the coordinate of <span class="math inline">\(D_j\)</span>, and <span class="math inline">\(l_i,l_j\)</span> are length of flows <span class="math inline">\(\overrightarrow{O_iD_i}\)</span> and <span class="math inline">\(\overrightarrow{O_jD_j}\)</span>.</p>
<p>This is implementated by the following codes.</p>
<div class="cell" data-hash="index_cache/html/d4-gwr-dmat_3f65ef18c9067e7e5fd8771897c5cca1">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>d4_origin <span class="ot">&lt;-</span> data_d4<span class="sc">$</span>coords[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>d4_dest <span class="ot">&lt;-</span> d4_origin <span class="sc">+</span> <span class="fu">with</span>(<span class="fu">as.data.frame</span>(data_d4<span class="sc">$</span>coords), <span class="fu">matrix</span>(<span class="fu">cbind</span>(U4 <span class="sc">*</span> <span class="fu">cos</span>(U3), U4 <span class="sc">*</span> <span class="fu">sin</span>(U3)), <span class="at">ncol =</span> <span class="dv">2</span>))</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>d4_od <span class="ot">&lt;-</span> <span class="fu">cbind</span>(d4_origin, d4_dest, data_d4<span class="sc">$</span>coords[, <span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>])</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(d4_od) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ox"</span>, <span class="st">"oy"</span>, <span class="st">"dx"</span>, <span class="st">"dy"</span>, <span class="st">"angle"</span>, <span class="st">"length"</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>d4_dmat <span class="ot">&lt;-</span> <span class="fu">apply</span>(d4_od, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) {</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">colSums</span>((<span class="fu">t</span>(d4_od[,<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]) <span class="sc">-</span> x[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>])<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">/</span> x[<span class="st">"length"</span>] <span class="sc">/</span> d4_od[, <span class="st">"length"</span>])</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>d4_dmat[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]      [,2]      [,3]      [,4]      [,5]
[1,] 0.0000000 1.4077782 1.2585313 1.3656097 0.9873034
[2,] 1.4077782 0.0000000 0.5916647 0.6618936 1.0783478
[3,] 1.2585313 0.5916647 0.0000000 1.1402567 1.3717634
[4,] 1.3656097 0.6618936 1.1402567 0.0000000 0.5994136
[5,] 0.9873034 1.0783478 1.3717634 0.5994136 0.0000000</code></pre>
</div>
</div>
<p>Then use the distance matrix <code>d4_dmat</code> as weighting criterion in GWR.</p>
<div class="cell" data-hash="index_cache/html/d4-gwr-model_b4241711530ee578e618224c8c07b1c3">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>d4sp <span class="ot">&lt;-</span> <span class="fu">cbind</span>(data_d4<span class="sc">$</span>data)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(d4sp) <span class="ot">&lt;-</span> data_d4<span class="sc">$</span>coords[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>d4_gwr_bw <span class="ot">&lt;-</span> <span class="fu">bw.gwr</span>(</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3, <span class="at">data =</span> d4sp,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">adaptive =</span> T, <span class="at">dMat =</span> d4_dmat</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Take a cup of tea and have a break, it will take a few minutes.
          -----A kind suggestion from GWmodel development group
Adaptive bandwidth: 3097 CV score: 27063.63 
Adaptive bandwidth: 1922 CV score: 26809.04 
Adaptive bandwidth: 1194 CV score: 26172.95 
Adaptive bandwidth: 746 CV score: 25282.31 
Adaptive bandwidth: 467 CV score: 24435.03 
Adaptive bandwidth: 296 CV score: 23756.82 
Adaptive bandwidth: 189 CV score: 23263.05 
Adaptive bandwidth: 124 CV score: 22945.49 
Adaptive bandwidth: 82 CV score: 22825.49 
Adaptive bandwidth: 58 CV score: 22944.28 
Adaptive bandwidth: 98 CV score: 22847.02 
Adaptive bandwidth: 72 CV score: 22835.85 
Adaptive bandwidth: 87 CV score: 22844.34 
Adaptive bandwidth: 77 CV score: 22829.18 
Adaptive bandwidth: 83 CV score: 22829.85 
Adaptive bandwidth: 79 CV score: 22825.71 
Adaptive bandwidth: 81 CV score: 22821.32 
Adaptive bandwidth: 83 CV score: 22829.85 
Adaptive bandwidth: 82 CV score: 22825.49 
Adaptive bandwidth: 83 CV score: 22829.85 
Adaptive bandwidth: 82 CV score: 22825.49 
Adaptive bandwidth: 82 CV score: 22825.49 
Adaptive bandwidth: 81 CV score: 22821.32 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>d4_gwr <span class="ot">&lt;-</span> <span class="fu">gwr.basic</span>(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3, <span class="at">data =</span> d4sp,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">bw =</span> d4_gwr_bw, <span class="at">adaptive =</span> T, <span class="at">dMat =</span> d4_dmat</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>d4_gwr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   ***********************************************************************
   *                       Package   GWmodel                             *
   ***********************************************************************
   Program starts at: 2023-03-28 17:49:16 
   Call:
   gwr.basic(formula = y ~ x1 + x2 + x3, data = d4sp, bw = d4_gwr_bw, 
    adaptive = T, dMat = d4_dmat)

   Dependent (y) variable:  y
   Independent variables:  x1 x2 x3
   Number of data points: 5000
   ***********************************************************************
   *                    Results of Global Regression                     *
   ***********************************************************************

   Call:
    lm(formula = formula, data = data)

   Residuals:
     Min       1Q   Median       3Q      Max 
-19.6256  -1.2957  -0.1548   1.0775  28.6380 

   Coefficients:
                Estimate Std. Error t value Pr(&gt;|t|)   
   (Intercept) -0.003055   0.032933  -0.093  0.92609   
   x1           0.054850   0.032961   1.664  0.09616 . 
   x2           0.093825   0.032946   2.848  0.00442 **
   x3           0.062644   0.033052   1.895  0.05811 . 

   ---Significance stars
   Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 
   Residual standard error: 2.328 on 4996 degrees of freedom
   Multiple R-squared: 0.002916
   Adjusted R-squared: 0.002317 
   F-statistic:  4.87 on 3 and 4996 DF,  p-value: 0.002203 
   ***Extra Diagnostic information
   Residual sum of squares: 27080.44
   Sigma(hat): 2.327715
   AIC:  22646.25
   AICc:  22646.27
   BIC:  17721.43
   ***********************************************************************
   *          Results of Geographically Weighted Regression              *
   ***********************************************************************

   *********************Model calibration information*********************
   Kernel function: bisquare 
   Adaptive bandwidth: 81 (number of nearest neighbours)
   Regression points: the same locations as observations are used.
   Distance metric: A distance matrix is specified for this model calibration.

   ****************Summary of GWR coefficient estimates:******************
                  Min.   1st Qu.    Median   3rd Qu.   Max.
   Intercept -1.429833 -0.486051 -0.203637  0.148622 2.9955
   x1        -1.110369 -0.443654 -0.171952  0.183283 4.6331
   x2        -1.010210 -0.334072 -0.071004  0.203844 3.4854
   x3        -1.396231 -0.456705 -0.169986  0.212258 3.3622
   ************************Diagnostic information*************************
   Number of data points: 5000 
   Effective number of parameters (2trace(S) - trace(S'S)): 1119.033 
   Effective degrees of freedom (n-2trace(S) + trace(S'S)): 3880.967 
   AICc (GWR book, Fotheringham, et al. 2002, p. 61, eq 2.33): 21308.13 
   AIC (GWR book, Fotheringham, et al. 2002,GWR p. 96, eq. 4.22): 20202.63 
   BIC (GWR book, Fotheringham, et al. 2002,GWR p. 61, eq. 2.34): 21205.94 
   Residual sum of squares: 14187.55 
   R-square value:  0.4776237 
   Adjusted R-square value:  0.3269636 

   ***********************************************************************
   Program stops at: 2023-03-28 17:49:20 </code></pre>
</div>
</div>
</section>
<section id="analysis-1" class="level3">
<h3 class="anchored" data-anchor-id="analysis-1">Analysis</h3>
<p>Closeness between coefficient estimates and actual values are shown in the following figure.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-7_8a08c6e0ca571bf5e04353e69b6ad782">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(<span class="at">DLSM =</span> d4_gwdr<span class="sc">$</span>betas, <span class="at">GWR =</span> d4_gwr<span class="sc">$</span>SDF<span class="sc">@</span>data) <span class="sc">%&gt;%</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">select</span>(.x, Intercept, x1, x2, x3)) <span class="sc">%&gt;%</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map2_dfr</span>(., <span class="fu">names</span>(.), <span class="cf">function</span>(model, model_name) {</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">map_dfr</span>(<span class="fu">c</span>(<span class="st">"Intercept"</span>, <span class="st">"x1"</span>, <span class="st">"x2"</span>, <span class="st">"x3"</span>), <span class="sc">~</span> <span class="fu">data.frame</span>(</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">Estimated =</span> model[[.x]],</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">Real =</span> data_d4<span class="sc">$</span>beta[[.x]],</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">Model =</span> model_name,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">Coefficient =</span> .x</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">%&gt;%</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Real, <span class="at">y =</span> Estimated)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"darkgreen"</span>) <span class="sc">+</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_poly_eq</span>() <span class="sc">+</span> <span class="fu">stat_poly_line</span>() <span class="sc">+</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="at">rows =</span> <span class="fu">vars</span>(Model), <span class="at">cols =</span> <span class="fu">vars</span>(Coefficient)) <span class="sc">+</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>RMSE and MAE evaluations are shown in the following figure.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-8_67ed232fc147fca8029459f3c78fa089">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(<span class="at">DLSM =</span> d4_gwdr<span class="sc">$</span>betas, <span class="at">GWR =</span> d4_gwr<span class="sc">$</span>SDF<span class="sc">@</span>data) <span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">select</span>(.x, Intercept, x1, x2, x3)) <span class="sc">%&gt;%</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map2_dfr</span>(., <span class="fu">names</span>(.), <span class="cf">function</span>(model, model_name) {</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">map_dfr</span>(<span class="fu">c</span>(<span class="st">"Intercept"</span>, <span class="st">"x1"</span>, <span class="st">"x2"</span>, <span class="st">"x3"</span>), <span class="sc">~</span> <span class="fu">data.frame</span>(</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">RMSE =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((data_d4<span class="sc">$</span>beta[[.x]] <span class="sc">-</span> model[[.x]])<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">MAE =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(data_d4<span class="sc">$</span>beta[[.x]] <span class="sc">-</span> model[[.x]])),</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">Model =</span> model_name,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">Coefficient =</span> .x</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">%&gt;%</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map_dfr</span>(<span class="fu">c</span>(<span class="st">"RMSE"</span>, <span class="st">"MAE"</span>), <span class="cf">function</span>(i, model) {</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">data.frame</span>(<span class="at">Value =</span> model[[i]],</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">Indicator =</span> i,</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>                   <span class="at">Model =</span> model<span class="sc">$</span>Model,</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>                   <span class="at">Coefficient =</span> model<span class="sc">$</span>Coefficient)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    }, .) <span class="sc">%&gt;%</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Coefficient, <span class="at">y =</span> Value, <span class="at">fill =</span> Model)) <span class="sc">+</span> </span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">y =</span> Value <span class="sc">+</span> <span class="fl">0.02</span>, <span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">"%.2f"</span>, Value)),</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>              <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="at">cols =</span> <span class="fu">vars</span>(Indicator)) <span class="sc">+</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Results show that DLSM works well for spatial line data even without defining distance metrics. It performs better than GWR according to mean of estimation errors, but a few outliers exist in estimates. GWR selected a much smaller bandwidth (173 neighbours). Thus, the risk of overfitting reappears.</p>
</section>
</section>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<p>In this post, the usage and some examples for DLSM is demonstrated. It offers more flexibility because of its three alterable parts: a space where samples exist, a set of kernels selected for every dimension and a locally weighted regression method. Simulation shows that DLSM can be applied to many kinds of spatial data without specially defined distance metrics, such as spatio-temporal data and spatial interaction data. It can also help tackle the effects of anisotropy because it has, in effect, a multidimensional bandwidth and decay function, measuring “closeness” in multiple dimensions simultaneously. In the future, researchers no longer need to design distance metrics to bring together, in a rather ad hoc way, different types of space and coordinate systems into the distance decay function. Assigning a weighting scheme to each of the dimensions and then pooling across them is suggested as a better alternative.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-gtwr-addin" class="csl-entry" role="doc-biblioentry">
Huang, Bo, and Jionghua Wang. 2020. <span>“GTWR ADDIN (Valid till Dec 31, 2022).”</span>
</div>
<div id="ref-HuangWu-2010a" class="csl-entry" role="doc-biblioentry">
Huang, Bo, Bo Wu, and Michael Barry. 2010. <span>“Geographically and Temporally Weighted Regression for Modeling Spatio-Temporal Variation in House Prices.”</span> <em>International Journal of Geographical Information Science</em> 24 (3): 383–401. <a href="https://doi.org/10.1080/13658810802672469">https://doi.org/10.1080/13658810802672469</a>.
</div>
<div id="ref-KordiFotheringham-2016a" class="csl-entry" role="doc-biblioentry">
Kordi, Maryam, and A. Stewart Fotheringham. 2016. <span>“Spatially <span>Weighted Interaction Models</span> (<span>SWIM</span>).”</span> <em>Annals of the American Association of Geographers</em> 106 (5): 990–1012. <a href="https://doi.org/10.1080/24694452.2016.1191990">https://doi.org/10.1080/24694452.2016.1191990</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>