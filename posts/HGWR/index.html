<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Yigong Hu">
<meta name="dcterms.date" content="2023-03-25">

<title>Yigong Hu’s Supplemental Materials for GIScience - A Hierarchical and Geographically Weighted Regression Model and Its Backfitting Maximum Likelihood Estimator</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/videojs/video.min.js"></script>
<link href="../../site_libs/quarto-contrib/videojs/video-js.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Yigong Hu’s Supplemental Materials for GIScience</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/HPDell/"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">A Hierarchical and Geographically Weighted Regression Model and Its Backfitting Maximum Likelihood Estimator</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Yigong Hu </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 25, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#installation" id="toc-installation" class="nav-link active" data-scroll-target="#installation">Installation</a>
  <ul class="collapse">
  <li><a href="#from-cran" id="toc-from-cran" class="nav-link" data-scroll-target="#from-cran">From CRAN</a></li>
  <li><a href="#from-source-code" id="toc-from-source-code" class="nav-link" data-scroll-target="#from-source-code">From Source Code</a></li>
  </ul></li>
  <li><a href="#usage" id="toc-usage" class="nav-link" data-scroll-target="#usage">Usage</a></li>
  <li><a href="#simulation-experiment" id="toc-simulation-experiment" class="nav-link" data-scroll-target="#simulation-experiment">Simulation Experiment</a>
  <ul class="collapse">
  <li><a href="#data-generation" id="toc-data-generation" class="nav-link" data-scroll-target="#data-generation">Data Generation</a></li>
  <li><a href="#model-calibration" id="toc-model-calibration" class="nav-link" data-scroll-target="#model-calibration">Model Calibration</a>
  <ul class="collapse">
  <li><a href="#hgwr" id="toc-hgwr" class="nav-link" data-scroll-target="#hgwr">HGWR</a></li>
  <li><a href="#gwr" id="toc-gwr" class="nav-link" data-scroll-target="#gwr">GWR</a></li>
  <li><a href="#hlm" id="toc-hlm" class="nav-link" data-scroll-target="#hlm">HLM</a></li>
  <li><a href="#mgwr" id="toc-mgwr" class="nav-link" data-scroll-target="#mgwr">MGWR</a></li>
  </ul></li>
  <li><a href="#estimate-analysis" id="toc-estimate-analysis" class="nav-link" data-scroll-target="#estimate-analysis">Estimate Analysis</a></li>
  <li><a href="#estimation-errors" id="toc-estimation-errors" class="nav-link" data-scroll-target="#estimation-errors">Estimation Errors</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>Hierarchical and geographically weighted regression (HGWR) is a spatial modelling method designed for data with a spatially hierarchical structure, i.e., samples are grouped by their locations. Variables are divied into group level and sample level. It calibrate three types of effects: local fixed effects, global fixed effects, and random effects. Only group level variables can be local fixed effects. In this post, the usage and some examples are going to be shown with R code.</p>
<section id="installation" class="level1">
<h1>Installation</h1>
<p>The HGWR model is implemented with C++ and R codes. And we have published an R package <strong>hgwrr</strong> to provice easy-to-use user interfaces to build HGWR moddels.</p>
<section id="from-cran" class="level2">
<h2 class="anchored" data-anchor-id="from-cran">From CRAN</h2>
<p>Install the <strong>hgwrr</strong> package from CRAN is very easy, through</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"hgwrr"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note if you are using Linux or macOS platforms, this package requires GSL to be installed and can be found by R. Please install it using your package manager, like <code>apt</code>, <code>dnf</code>, and <code>brew</code>. On Windows, the pre-built binary package would be provided by CRAN.</p>
</section>
<section id="from-source-code" class="level2">
<h2 class="anchored" data-anchor-id="from-source-code">From Source Code</h2>
<p>Please download the [R source package (v0.3.0)] and install it via the following code</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> CMD INSTALL hgwrr_0.3-0.tar.gz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Please make sure that the following dependencies are already installed in your R environment:</p>
<ul>
<li>Armadillo</li>
<li>GSL</li>
</ul>
<p>Just the package-manager versions are enough.</p>
</section>
</section>
<section id="usage" class="level1">
<h1>Usage</h1>
<p>An HGWR model can be calibrated using the following function,</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hgwr</span>(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  formula, data, local.fixed, coords, bw,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="fl">0.01</span>, <span class="at">eps_iter =</span> <span class="fl">1e-06</span>, <span class="at">eps_gradient =</span> <span class="fl">1e-06</span>, <span class="at">max_iters =</span> <span class="fl">1e+06</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_retries =</span> <span class="fl">1e+06</span>, <span class="at">ml_type =</span> HGWR_ML_TYPE_D_ONLY, <span class="at">verbose =</span> <span class="dv">0</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There seems to be quite a few arguments, but most of them have default values which would be fine on most ocassions. The first five arguments are mandatory.</p>
<dl>
<dt><code>formula</code></dt>
<dd>
<p>This argument accepts a formula object in R. Its format follows lme4 package. As there are two types of effects: fixed effects and random effects, we use the following format to specify both of them</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>dependent <span class="sc">~</span> fixed1 <span class="sc">+</span> fixed2 <span class="sc">+</span> (random1 <span class="sc">+</span> random2 <span class="sc">|</span> group)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</dd>
<dt><code>data</code></dt>
<dd>
It accepts a DataFrame object in R. All variables specified in formula are extracted from data. In this stage, <code>Spatial*DataFrame</code> is not supported, and will not be supported in the future.
</dd>
<dt><code>local.fixed</code></dt>
<dd>
It accepts a list of character specifying which fixed effects are local. For example, if <code>fixed1</code> needs to be locally fixed, then set <code>local.fixed</code> to <code>c("fixed1")</code>.
</dd>
<dt><code>coords</code></dt>
<dd>
It accepts a matrix of 2 columns. Each row is the longitude and latitude of each group.
</dd>
<dt><code>bw</code></dt>
<dd>
It accepts an integer or numeric number to specify the bandwidth used in geographically weighted process. Currently, it can only be adaptive bandwidth.
</dd>
</dl>
<p>For other arguments, if the default values cause some problems, and you want to change some of them, please check the documentation of function hgwr() for more infomation.</p>
</section>
<section id="simulation-experiment" class="level1">
<h1>Simulation Experiment</h1>
<p>To carry out the experiment, there are some packages required to be in your R environment. Please install them if they are abscent.</p>
<ul>
<li><a href="https://cran.r-project.org/web/packages/tidyverse/index.html">tidyverse</a></li>
<li><a href="https://cran.r-project.org/web/packages/ggpmisc/index.html">ggpmisc</a></li>
<li><a href="https://cran.r-project.org/web/packages/ggpubr/index.html">ggpubr</a></li>
<li><a href="https://cran.r-project.org/web/packages/Metrics/index.html">Metrics</a></li>
<li><a href="https://cran.r-project.org/web/packages/sf/index.html">sf</a></li>
<li><a href="https://cran.r-project.org/web/packages/MASS/index.html">MASS</a></li>
<li><a href="https://cran.r-project.org/web/packages/GWmodel/index.html">GWmodel</a></li>
<li><a href="https://cran.r-project.org/web/packages/lmerTest/index.html">lmerTest</a></li>
<li><a href="https://cran.r-project.org/web/packages/performance/index.html">performance</a></li>
</ul>
<p>The CRAN versions now are fine.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-1_ae4b1765f915dc84d6c55df9ff3f6377">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Metrics)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hgwrr)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GWmodel)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="data-generation" class="level2">
<h2 class="anchored" data-anchor-id="data-generation">Data Generation</h2>
<p>The data used in this experiment is generated by the following code. This process is inspired by <span class="citation" data-cites="FotheringhamYang-2017">Fotheringham, Yang, and Kang (<a href="#ref-FotheringhamYang-2017" role="doc-biblioref">2017</a>)</span>.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-2_5dabf574d1ac70570a67b41657865240">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>nu <span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>nv <span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>ncoords <span class="ot">&lt;-</span> nu <span class="sc">*</span> nv</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="fu">seq_len</span>(nu) <span class="sc">-</span> <span class="dv">1</span>, <span class="at">each =</span> <span class="dv">25</span>), <span class="fu">rep</span>(<span class="fu">seq_len</span>(nv) <span class="sc">-</span> <span class="dv">1</span>, <span class="at">times =</span> <span class="dv">25</span>)), <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(coords) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"u"</span>, <span class="st">"v"</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> coords[[<span class="st">"u"</span>]]</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> coords[[<span class="st">"v"</span>]]</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">&lt;-</span> (<span class="dv">36</span> <span class="sc">-</span> (<span class="dv">6</span> <span class="sc">-</span> u<span class="sc">/</span><span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>(<span class="dv">36</span> <span class="sc">-</span> (<span class="dv">6</span> <span class="sc">-</span> v<span class="sc">/</span><span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span><span class="dv">324</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>g2 <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span> (<span class="fu">scale</span>(u)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fu">scale</span>(v)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>h1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">2</span>, <span class="at">times =</span> ncoords)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">648</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>z1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(ncoords, <span class="at">mean =</span> <span class="dv">2</span>, <span class="at">sd =</span> <span class="fl">0.5</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12574</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>b0 <span class="ot">&lt;-</span> (u <span class="sc">+</span> v) <span class="sc">/</span> <span class="dv">12</span> <span class="sc">-</span> <span class="dv">2</span> <span class="sc">+</span> <span class="fu">rnorm</span>(ncoords, <span class="at">mean =</span> <span class="dv">2</span>, <span class="at">sd =</span> <span class="fl">0.2</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>betas <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Intercept =</span> b0, g1, g2, h1, z1)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">648</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>nsamples <span class="ot">&lt;-</span> <span class="fu">floor</span>(<span class="fu">runif</span>(ncoords, <span class="dv">20</span>, <span class="dv">50</span>))</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>iloc <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">seq_len</span>(ncoords), <span class="at">times =</span> nsamples)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="fu">sum</span>(nsamples), <span class="at">mu =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">4</span>), <span class="at">Sigma =</span> <span class="fu">diag</span>(<span class="dv">4</span>))</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>x[,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(x[,<span class="dv">1</span>], <span class="at">by =</span> <span class="fu">list</span>(iloc), <span class="at">FUN =</span> mean)[[<span class="st">"x"</span>]] <span class="sc">%&gt;%</span> <span class="fu">rep</span>(<span class="at">times =</span> nsamples)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>x[,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(x[,<span class="dv">2</span>], <span class="at">by =</span> <span class="fu">list</span>(iloc), <span class="at">FUN =</span> mean)[[<span class="st">"x"</span>]] <span class="sc">%&gt;%</span> <span class="fu">rep</span>(<span class="at">times =</span> nsamples)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(x) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"g1"</span>, <span class="st">"g2"</span>, <span class="st">"h1"</span>, <span class="st">"z1"</span>)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fu">sum</span>(nsamples))</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">cbind</span>(<span class="dv">1</span>, x) <span class="sc">*</span> <span class="fu">as.matrix</span>(betas[iloc,])) <span class="sc">+</span> e</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">y =</span> y, x, <span class="at">group =</span> iloc) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data,</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">betas =</span> betas,</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">coords =</span> coords</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>sim_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(<span class="fu">with</span>(sim, <span class="fu">cbind</span>(data, coords[data<span class="sc">$</span>group,])), <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"u"</span>, <span class="st">"v"</span>))</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(sim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ data  :'data.frame': 21434 obs. of  6 variables:
  ..$ y    : num [1:21434] 4.274 0.952 -2.278 1.21 4.547 ...
  ..$ g1   : num [1:21434] -0.154 -0.154 -0.154 -0.154 -0.154 ...
  ..$ g2   : num [1:21434] 0.109 0.109 0.109 0.109 0.109 ...
  ..$ h1   : num [1:21434] 3.169 -0.031 -1.092 -0.983 1.719 ...
  ..$ z1   : num [1:21434] -0.626 0.184 -0.836 1.595 0.33 ...
  ..$ group: num [1:21434] 1 1 1 1 1 1 1 1 1 1 ...
 $ betas :'data.frame': 625 obs. of  5 variables:
  ..$ Intercept: num [1:625] 0.35 0.429 0.33 0.267 0.465 ...
  ..$ g1       : num [1:625] 0 0 0 0 0 0 0 0 0 0 ...
  ..$ g2       : num [1:625] 0.252 0.314 0.384 0.461 0.543 ...
  ..$ h1       : num [1:625] 2 2 2 2 2 2 2 2 2 2 ...
  ..$ z1       : num [1:625] 2.46 2.63 1.25 1.91 1.91 ...
 $ coords:'data.frame': 625 obs. of  2 variables:
  ..$ u: num [1:625] 0 0 0 0 0 0 0 0 0 0 ...
  ..$ v: num [1:625] 0 1 2 3 4 5 6 7 8 9 ...</code></pre>
</div>
</div>
<p>With this data, we are going to calibrate a HGWR model, geographically weighted regression <span class="citation" data-cites="BrunsdonFotheringham-1996">(GWR, <a href="#ref-BrunsdonFotheringham-1996" role="doc-biblioref">Brunsdon, Fotheringham, and Charlton 1996</a>)</span> model, multiscale geographically weighted regression <span class="citation" data-cites="LuBrunsdon-2017">(MGWR, the PSDM implementation, <a href="#ref-LuBrunsdon-2017" role="doc-biblioref">Lu et al. 2017</a>)</span> model, and hierarchical linear model <span class="citation" data-cites="Raudenbush-1993">(HLM, <a href="#ref-Raudenbush-1993" role="doc-biblioref">Raudenbush 1993</a>)</span>. The MGWR model requires a very large amout of memory and time, so we only demonstrate the workable codes here. The result we got on a high-performance computing platform is used instead.</p>
</section>
<section id="model-calibration" class="level2">
<h2 class="anchored" data-anchor-id="model-calibration">Model Calibration</h2>
<section id="hgwr" class="level3">
<h3 class="anchored" data-anchor-id="hgwr">HGWR</h3>
<p>A HGWR model is calibrated with the following code.</p>
<div class="cell" data-hash="index_cache/html/sim-hgwr-model_cdd7e88b5519f1bbfdcbd75bc238fcef">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>hgwr_formula <span class="ot">&lt;-</span> y <span class="sc">~</span> g1 <span class="sc">+</span> g2 <span class="sc">+</span> h1 <span class="sc">+</span> (z1 <span class="sc">|</span> group)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>hgwr_model <span class="ot">&lt;-</span> <span class="fu">hgwr</span>(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    hgwr_formula, sim<span class="sc">$</span>data, <span class="fu">c</span>(<span class="st">"g1"</span>, <span class="st">"g2"</span>), sim<span class="sc">$</span>coords, <span class="st">"CV"</span>, </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">kernel =</span> <span class="st">"bisquared"</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(hgwr_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hierarchical and geographically weighted regression model
=========================================================
Formula: hgwr_formula
 Method: Back-fitting and Maximum likelihood
   Data: sim$data

Diagnostics
-----------
 Rsquared 
 0.908050 

Scaled residuals
----------------
       Min         1Q    Median        3Q       Max 
 -3.995269  -0.648274  0.000561  0.652537  3.530948 

Other Information
-----------------
Number of Obs: 21434
       Groups: group , 625</code></pre>
</div>
</div>
</section>
<section id="gwr" class="level3">
<h3 class="anchored" data-anchor-id="gwr">GWR</h3>
<div class="cell" data-hash="index_cache/html/sim-gwr-model_dd6f6c4019ac997ab9d0037bca436e29">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>sim_sp <span class="ot">&lt;-</span> <span class="fu">as</span>(sim_sf, <span class="at">Class =</span> <span class="st">"Spatial"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>gwr_formula <span class="ot">&lt;-</span> y <span class="sc">~</span> g1 <span class="sc">+</span> g2 <span class="sc">+</span> h1 <span class="sc">+</span> z1</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>gwr_bw <span class="ot">&lt;-</span> <span class="fu">bw.gwr</span>(gwr_formula, sim_sp, <span class="at">approach =</span> <span class="st">"AIC"</span>, <span class="at">adaptive =</span> T, <span class="at">kernel =</span> <span class="st">"bisquare"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Take a cup of tea and have a break, it will take a few minutes.
          -----A kind suggestion from GWmodel development group
Adaptive bandwidth (number of nearest neighbours): 13254 AICc value: 68302.68 
Adaptive bandwidth (number of nearest neighbours): 8199 AICc value: 67235.53 
Adaptive bandwidth (number of nearest neighbours): 5074 AICc value: 66677.95 
Adaptive bandwidth (number of nearest neighbours): 3143 AICc value: 66381.08 
Adaptive bandwidth (number of nearest neighbours): 1949 AICc value: 66152.06 
Adaptive bandwidth (number of nearest neighbours): 1212 AICc value: 65879.63 
Adaptive bandwidth (number of nearest neighbours): 755 AICc value: 65553.06 
Adaptive bandwidth (number of nearest neighbours): 474 AICc value: 65089.52 
Adaptive bandwidth (number of nearest neighbours): 299 AICc value: 64121.17 
Adaptive bandwidth (number of nearest neighbours): 192 AICc value: 113016 
Adaptive bandwidth (number of nearest neighbours): 366 AICc value: 64842.55 
Adaptive bandwidth (number of nearest neighbours): 258 AICc value: 63736.27 
Adaptive bandwidth (number of nearest neighbours): 232 AICc value: 63688.32 
Adaptive bandwidth (number of nearest neighbours): 216 AICc value: 64235.33 
Adaptive bandwidth (number of nearest neighbours): 241 AICc value: 63684.82 
Adaptive bandwidth (number of nearest neighbours): 248 AICc value: 63701.3 
Adaptive bandwidth (number of nearest neighbours): 238 AICc value: 63682.91 
Adaptive bandwidth (number of nearest neighbours): 235 AICc value: 63681.33 
Adaptive bandwidth (number of nearest neighbours): 234 AICc value: 63681.33 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>gwr_model <span class="ot">&lt;-</span> <span class="fu">gwr.basic</span>(gwr_formula, sim_sp, <span class="at">bw =</span> gwr_bw, <span class="at">adaptive =</span> T, <span class="at">kernel =</span> <span class="st">"bisquare"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>gwr_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   ***********************************************************************
   *                       Package   GWmodel                             *
   ***********************************************************************
   Program starts at: 2023-03-30 11:46:44 
   Call:
   gwr.basic(formula = gwr_formula, data = sim_sp, bw = gwr_bw, 
    kernel = "bisquare", adaptive = T)

   Dependent (y) variable:  y
   Independent variables:  g1 g2 h1 z1
   Number of data points: 21434
   ***********************************************************************
   *                    Results of Global Regression                     *
   ***********************************************************************

   Call:
    lm(formula = formula, data = data)

   Residuals:
    Min      1Q  Median      3Q     Max 
-5.6729 -0.9458 -0.0075  0.9499  5.3801 

   Coefficients:
               Estimate Std. Error t value Pr(&gt;|t|)    
   (Intercept) 2.002434   0.009684  206.78   &lt;2e-16 ***
   g1          1.659038   0.057600   28.80   &lt;2e-16 ***
   g2          1.791212   0.056544   31.68   &lt;2e-16 ***
   h1          2.010065   0.009660  208.09   &lt;2e-16 ***
   z1          2.042761   0.009661  211.44   &lt;2e-16 ***

   ---Significance stars
   Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 
   Residual standard error: 1.417 on 21429 degrees of freedom
   Multiple R-squared: 0.8064
   Adjusted R-squared: 0.8064 
   F-statistic: 2.232e+04 on 4 and 21429 DF,  p-value: &lt; 2.2e-16 
   ***Extra Diagnostic information
   Residual sum of squares: 43019.04
   Sigma(hat): 1.416769
   AIC:  75771.36
   AICc:  75771.37
   BIC:  54445.03
   ***********************************************************************
   *          Results of Geographically Weighted Regression              *
   ***********************************************************************

   *********************Model calibration information*********************
   Kernel function: bisquare 
   Adaptive bandwidth: 234 (number of nearest neighbours)
   Regression points: the same locations as observations are used.
   Distance metric: Euclidean distance metric is used.

   ****************Summary of GWR coefficient estimates:******************
                 Min.  1st Qu.   Median  3rd Qu.    Max.
   Intercept -0.36804  1.37847  1.98864  2.63158  3.8950
   g1        -5.46208  0.37769  1.59423  2.78590 11.7942
   g2        -5.90918  0.79411  1.74163  2.85702 13.1842
   h1         1.51922  1.94629  2.01310  2.07438  2.3601
   z1         1.14097  1.83026  2.01883  2.21836  2.8169
   ************************Diagnostic information*************************
   Number of data points: 21434 
   Effective number of parameters (2trace(S) - trace(S'S)): 1348.983 
   Effective degrees of freedom (n-2trace(S) + trace(S'S)): 20085.02 
   AICc (GWR book, Fotheringham, et al. 2002, p. 61, eq 2.33): 63681.33 
   AIC (GWR book, Fotheringham, et al. 2002,GWR p. 96, eq. 4.22): 62482 
   BIC (GWR book, Fotheringham, et al. 2002,GWR p. 61, eq. 2.34): 50756.14 
   Residual sum of squares: 22014.71 
   R-square value:  0.9009503 
   Adjusted R-square value:  0.8942974 

   ***********************************************************************
   Program stops at: 2023-03-30 11:47:26 </code></pre>
</div>
</div>
</section>
<section id="hlm" class="level3">
<h3 class="anchored" data-anchor-id="hlm">HLM</h3>
<div class="cell" data-hash="index_cache/html/sim-hlm-model_58ff94dfeba8203e355a476b50ff1fe2">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>hlm_model <span class="ot">&lt;-</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(y <span class="sc">~</span> g1 <span class="sc">+</span> g2 <span class="sc">+</span> h1 <span class="sc">+</span> z1 <span class="sc">+</span> (z1 <span class="sc">|</span> group), sim<span class="sc">$</span>data)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(hlm_model)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>performance<span class="sc">::</span><span class="fu">r2</span>(hlm_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: y ~ g1 + g2 + h1 + z1 + (z1 | group)
   Data: sim$data

REML criterion at convergence: 64443.4

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-3.9791 -0.6478  0.0011  0.6521  3.5484 

Random effects:
 Groups   Name        Variance Std.Dev. Corr
 group    (Intercept) 0.7750   0.8804       
          z1          0.2511   0.5011   0.01
 Residual             1.0087   1.0044       
Number of obs: 21434, groups:  group, 625

Fixed effects:
             Estimate Std. Error        df t value Pr(&gt;|t|)    
(Intercept) 1.991e+00  3.595e-02 6.202e+02  55.377  &lt; 2e-16 ***
g1          1.581e+00  2.093e-01 6.230e+02   7.552 1.53e-13 ***
g2          1.805e+00  1.988e-01 6.261e+02   9.079  &lt; 2e-16 ***
h1          2.014e+00  7.043e-03 2.037e+04 286.022  &lt; 2e-16 ***
z1          2.026e+00  2.136e-02 6.228e+02  94.830  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
   (Intr) g1     g2     h1    
g1  0.007                     
g2  0.021 -0.041              
h1  0.000 -0.001  0.000       
z1  0.007  0.001  0.000  0.002
# R2 for Mixed Models

  Conditional R2: 0.902
     Marginal R2: 0.803</code></pre>
</div>
</div>
</section>
<section id="mgwr" class="level3">
<h3 class="anchored" data-anchor-id="mgwr">MGWR</h3>
<div class="cell" data-hash="index_cache/html/sim-mgwr-model_5f019d77398cec7b34c1866c24826fdc">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>mgwr_model <span class="ot">&lt;-</span> <span class="fu">gwr.multiscale</span>(y <span class="sc">~</span> g1 <span class="sc">+</span> g2 <span class="sc">+</span> h1 <span class="sc">+</span> z1, sim_sp, <span class="at">adaptive =</span> T)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>mgwr_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="index_cache/html/sim-mgwr-model-load_989b8f285a324f2ffd4463befb11e3e5">
<div class="cell-output cell-output-stdout">
<pre><code>   ***********************************************************************
   *                       Package   GWmodel                             *
   ***********************************************************************
   Program starts at: 2023-01-07 00:33:30 
   Call:
   gwr.multiscale(formula = y ~ g1 + g2 + h1 + z1, data = sim_sp, 
    adaptive = T, hatmatrix = F, parallel.method = "omp", parallel.arg = 48)

   Dependent (y) variable:  y
   Independent variables:  g1 g2 h1 z1
   Number of data points: 21434
   ***********************************************************************
   *                       Multiscale (PSDM) GWR                          *
   ***********************************************************************

   *********************Model calibration information*********************
   Kernel function: bisquare 
   Adaptive bandwidths for each coefficient(number of nearest neighbours): 
              (Intercept)    g1    g2    h1 z1
   Bandwidth          382  1054   474 19875 62

   ****************Summary of GWR coefficient estimates:******************
                  Min.   1st Qu.    Median   3rd Qu.   Max.
   Intercept  0.244383  1.451943  1.998243  2.611283 3.8138
   g1        -0.072043  0.746596  1.426176  2.567027 4.2021
   g2        -1.955412  0.969786  1.738936  2.659654 4.9470
   h1         2.003644  2.010011  2.015701  2.019937 2.0227
   z1         0.287334  1.691472  2.039915  2.376235 3.5291
   ************************Diagnostic information*************************

   ***********************************************************************
   Program stops at: 2023-01-07 04:58:17 </code></pre>
</div>
</div>
</section>
</section>
<section id="estimate-analysis" class="level2">
<h2 class="anchored" data-anchor-id="estimate-analysis">Estimate Analysis</h2>
<p>As the actual values of coefficients are already known, we can compare the performance of these models by comparing the closeness between their estimates and actual values.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-3_fe04ee99b62cd304fc6a0c10c39da710">
<details>
<summary>Create some handy variables.</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>coef_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Intercept"</span>, <span class="st">"g1"</span>, <span class="st">"g2"</span>, <span class="st">"h1"</span>, <span class="st">"z1"</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>coef_names_plot <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Intercept"</span>, <span class="st">"g1"</span>, <span class="st">"g2"</span>, <span class="st">"z1"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>coef_name_map <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">Intercept =</span> <span class="st">"alpha[0]"</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">g1 =</span> <span class="st">"gamma[1]"</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">g2 =</span> <span class="st">"gamma[2]"</span>,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">h1 =</span> <span class="st">"beta[1]"</span>,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x1 =</span> <span class="st">"beta[1]"</span>,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">z1 =</span> <span class="st">"mu[1]"</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>coef_name_labels <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">Intercept =</span> <span class="fu">bquote</span>(alpha[<span class="dv">0</span>]),</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">g1 =</span> <span class="fu">bquote</span>(gamma[<span class="dv">1</span>]),</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">g2 =</span> <span class="fu">bquote</span>(gamma[<span class="dv">2</span>]),</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">h1 =</span> <span class="fu">bquote</span>(beta[<span class="dv">1</span>]),</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">x1 =</span> <span class="fu">bquote</span>(beta[<span class="dv">1</span>]),</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">z1 =</span> <span class="fu">bquote</span>(mu[<span class="dv">1</span>])</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>models_name <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"GWR"</span>, <span class="st">"MGWR"</span>, <span class="st">"HLM"</span>, <span class="st">"HGWR"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Firstly, we collect coefficient estimates.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-4_534e27890df70aa89c1aeb9074140313">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Real values</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>beta0 <span class="ot">&lt;-</span> sim<span class="sc">$</span>betas[coef_names]</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="do">### HGWR</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>hgwr_betas <span class="ot">&lt;-</span> <span class="fu">coef</span>(hgwr_model)[coef_names]</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="do">### GWR</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>gwr_betas <span class="ot">&lt;-</span> gwr_model<span class="sc">$</span>SDF<span class="sc">@</span>data[coef_names] <span class="sc">%&gt;%</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aggregate</span>(<span class="at">by =</span> <span class="fu">list</span>(sim<span class="sc">$</span>data<span class="sc">$</span>group), <span class="at">FUN =</span> mean) <span class="sc">%&gt;%</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">all_of</span>(coef_names))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `as.tibble()` was deprecated in tibble 2.0.0.
ℹ Please use `as_tibble()` instead.
ℹ The signature and semantics have changed, see `?as_tibble`.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="do">### MGWR</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>mgwr_betas <span class="ot">&lt;-</span> mgwr_model<span class="sc">$</span>SDF<span class="sc">@</span>data[coef_names] <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aggregate</span>(<span class="at">by =</span> <span class="fu">list</span>(sim<span class="sc">$</span>data<span class="sc">$</span>group), <span class="at">FUN =</span> mean) <span class="sc">%&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">all_of</span>(coef_names))</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="do">### HLM</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>hlm_betas <span class="ot">&lt;-</span> <span class="fu">coef</span>(hlm_model)<span class="sc">$</span>group</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(hlm_betas)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">"Intercept"</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>hlm_betas <span class="ot">&lt;-</span> hlm_betas[coef_names]</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>models_coef <span class="ot">&lt;-</span> <span class="fu">map</span>(models_name, <span class="sc">~</span> <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="fu">tolower</span>(.x), <span class="st">"_betas"</span>)))</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(models_coef) <span class="ot">&lt;-</span> models_name</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>models_coef_real <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">list</span>(<span class="at">Real =</span> beta0), models_coef)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, plot estimate values at their location and the real values to see their distributions.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-5_d9dc585788a997f5c286d393532ea7e3">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>models_coef_real <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map_dfr</span>(<span class="cf">function</span>(x) {</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(x, <span class="fu">all_of</span>(coef_names)) <span class="sc">%&gt;%</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>            <span class="fu">map_dfr</span>(<span class="sc">~</span> <span class="fu">data.frame</span>(<span class="at">Value =</span> .x, sim<span class="sc">$</span>coords), <span class="at">.id =</span> <span class="st">"Coefficient"</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">.id =</span> <span class="st">"Algorithm"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Algorithm =</span> <span class="fu">ordered</span>(<span class="fu">as.factor</span>(Algorithm), <span class="fu">names</span>(models_coef_real)),</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">Coefficient =</span> <span class="fu">ordered</span>(<span class="fu">as.factor</span>(Coefficient), coef_names, </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">labels =</span> coef_name_map[coef_names])) <span class="sc">%&gt;%</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(u, v, <span class="at">fill =</span> Value)) <span class="sc">+</span> <span class="fu">geom_raster</span>() <span class="sc">+</span> </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>()) <span class="sc">+</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>()) <span class="sc">+</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale_fill_gradient2</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">4</span>), <span class="at">low =</span> <span class="st">"#000099"</span>, </span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>                             <span class="at">mid =</span> <span class="st">"#CCFF33"</span>, <span class="at">high =</span> <span class="st">"#CC0033"</span>,</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>                             <span class="at">midpoint =</span> <span class="dv">2</span>, <span class="at">oob =</span> scales<span class="sc">::</span>squish) <span class="sc">+</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">facet_grid</span>(<span class="at">rows =</span> <span class="fu">vars</span>(Algorithm), <span class="at">cols =</span> <span class="fu">vars</span>(Coefficient), <span class="at">labeller =</span> label_parsed) <span class="sc">+</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">coord_fixed</span>() <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.key.height =</span> <span class="fu">unit</span>(<span class="dv">10</span>, <span class="st">"pt"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>A scatter plot along with it may be useful.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-6_dac426593da5553d3b19c9f993de7188">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>beta_hat_real <span class="ot">&lt;-</span> models_coef <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map_dfr</span>(<span class="cf">function</span>(x) {</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">map_dfr</span>(coef_names, <span class="sc">~</span> <span class="fu">data.frame</span>(<span class="at">Coefficient =</span> .x, <span class="at">Estimated =</span> x[[.x]], <span class="at">Real =</span> beta0[[.x]]))</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">.id =</span> <span class="st">"Algorithm"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Algorithm =</span> <span class="fu">ordered</span>(<span class="fu">as.factor</span>(Algorithm), <span class="fu">names</span>(models_coef)),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">Coefficient =</span> <span class="fu">ordered</span>(<span class="fu">as.factor</span>(Coefficient), coef_names, <span class="at">labels =</span> coef_name_map[coef_names]))</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>beta_hat_rmse <span class="ot">&lt;-</span> beta_hat_real <span class="sc">%&gt;%</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_nest</span>(Algorithm, Coefficient) <span class="sc">%&gt;%</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">rmse =</span> <span class="fu">map</span>(data, <span class="sc">~</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((.x<span class="sc">$</span>Estimated <span class="sc">-</span> .x<span class="sc">$</span>Real)<span class="sc">^</span><span class="dv">2</span>))),</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> <span class="cn">NULL</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(beta_hat_real, <span class="fu">aes</span>(<span class="at">x =</span> Real, <span class="at">y =</span> Estimated)) <span class="sc">+</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">y =</span> <span class="cn">Inf</span>, <span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">"RMSE=%.3f"</span>, rmse)),</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> beta_hat_rmse, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">vjust =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">10</span>), <span class="at">oob =</span> scales<span class="sc">::</span>squish) <span class="sc">+</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="at">rows =</span> <span class="fu">vars</span>(Algorithm), <span class="at">cols =</span> <span class="fu">vars</span>(Coefficient), <span class="at">labeller =</span> label_parsed) <span class="sc">+</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>From these two figures, we can find that:</p>
<ol type="1">
<li>In the results of GWR, spatial heterogeneity is revealed in estimates for all variables. Although <span class="math inline">\(\hat{\beta}_1\)</span> should be constant across the study area, GWR still generate spatially varying estimates for it. This is a kind of over-fitting from the spatial perspective. Besides, as the bandwidth is small, estimates for <span class="math inline">\(\gamma_1\)</span> and <span class="math inline">\(\gamma_2\)</span> are too local. Consequently, there are quite a few outliers disrupting the spatial trend.</li>
<li>MGWR partly gets over issues of GWR by adopting parameter-specified bandwidths, instead of a uniform bandwidth. And it performs better when estimating <span class="math inline">\(\gamma_1\)</span> and <span class="math inline">\(\gamma_2\)</span>. For global fixed effects, MGWR still generates spatially varying estimates, but they vary much slightly than estimates from GWR. For random effects, the results are slightly smoothed as well. MGWR also borrow a few points from neighbors. There is another serious problem in MGWR that it requires too much computing time and memory.</li>
<li>In the results of HLM, there is only one estimate for <span class="math inline">\(\beta_1\)</span> across the whole area. And estimates for <span class="math inline">\(\mu_1\)</span>, The problem lies in estimates for <span class="math inline">\(\gamma_1\)</span> and <span class="math inline">\(\gamma_2\)</span>. As they are fixed effects in HLM, their estimates are also constant for all samples. However, spatial heterogeneity is expected in them.</li>
<li>HGWR is the final solution. For global fixed effects, it generates globally constant estimates for all samples. For random effects, it would not smooth the estimates because they are not obtained by borrowing points. And for local fixed effects, we can discover spatial heterogeneity from their estimates. And it would not repeat computation for samples at each location. Thus, only the number of locations obviously affects the computation efficiency. This can reduce a large amount of computing time and memory.</li>
</ol>
<p>There is an animation demonstrating the problem about bandwidth we addressed above.</p>
<div class="quarto-video"><video id="video_shortcode_videojs_video1" class="video-js vjs-default-skin vjs-fluid" controls="" preload="auto" data-setup="{}" title="Issues related to the bandwidth in hierarchical spatial data"><source src="https://hpdell.github.io/hgwr/assets/multisampling.mp4"></video></div>
<p>As shown in this video, bandwidths have inequal spatial scale for two samples (represented by cubes). Both the samples represented by large red cubes and large blue cubes take 41 neighbour samples to calibrate GWR models. For the red one, neighbours on 8 nearest locations are taken. But the figure for the blue one is only 6. This situation means estimated coefficients are more smoothed for the red samples. In other words, estimations for the blue samples are much local.</p>
<p>HGWR overcome this drawback by introducing hierarchical structure with a special designed backfitting estimator. With the popularity of spatiotemporal big data, situations wherein the specific parameters for which HGWR was optimized are becoming more prevalent, suggesting that HGWR holds considerable promise as a useful tool for analyzing such data sets.</p>
</section>
<section id="estimation-errors" class="level2">
<h2 class="anchored" data-anchor-id="estimation-errors">Estimation Errors</h2>
<p>We can use some indicators to evaulate estimation errors for each model and coefficient. The following code generate a box-plot of absolute coefficient errors <span class="math inline">\(\mathrm{AE}\)</span>, which is <span class="math display">\[
\mathrm{AE}_i = \left| r_i - e_i \right|
\]</span> where <span class="math inline">\(r_i\)</span> reprsents the real value at sample <span class="math inline">\(i\)</span>, and <span class="math inline">\(e_i\)</span> represents the corresponding estimate.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-7_6a16084268636c6384dee12772a8f684">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>models_coef <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">select</span>(.x, <span class="fu">all_of</span>(coef_names))) <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map_dfr</span>(<span class="cf">function</span>(x) {</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">map2_dfr</span>(x, <span class="fu">names</span>(x), <span class="sc">~</span> <span class="fu">data.frame</span>(<span class="at">ae =</span> <span class="fu">ae</span>(beta0[[.y]], .x)), <span class="at">.id =</span> <span class="st">"Coefficient"</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">.id =</span> <span class="st">"Algorithm"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Algorithm =</span> <span class="fu">ordered</span>(<span class="fu">as.factor</span>(Algorithm), <span class="fu">names</span>(models_coef)),</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">Coefficient =</span> <span class="fu">ordered</span>(<span class="fu">as.factor</span>(Coefficient), coef_names)) <span class="sc">%&gt;%</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(Coefficient, Algorithm) <span class="sc">%&gt;%</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Coefficient, <span class="at">y =</span> ae, <span class="at">fill =</span> Algorithm)) <span class="sc">+</span> <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale_y_log10</span>(<span class="at">name =</span> <span class="st">'Squared Error'</span>, <span class="at">labels =</span> <span class="sc">~</span> <span class="fu">sprintf</span>(<span class="st">"%g"</span>, .x)) <span class="sc">+</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale_x_discrete</span>(<span class="at">labels =</span> coef_name_labels[coef_names]) <span class="sc">+</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>, <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>And the following code generate a bar-plot showing root mean squared errors <span class="math inline">\(\mathrm{RMSE}\)</span> of each coefficient, which is <span class="math display">\[
\mathrm{RMSE} = \sum_{i=1}^n \left(r_1-e_i\right)^2
\]</span> where <span class="math inline">\(r_i\)</span> reprsents the real value at sample <span class="math inline">\(i\)</span>, and <span class="math inline">\(e_i\)</span> represents the corresponding estimate.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-8_f08303866a8148e927e577ae28d05942">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>models_coef <span class="sc">%&gt;%</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map_dfr</span>(<span class="cf">function</span> (alg) {</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">map_dfr</span>(coef_names, <span class="cf">function</span> (coef, real) {</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>            est_rmse <span class="ot">&lt;-</span> <span class="fu">rmse</span>(real[[coef]], alg[[coef]])</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>            <span class="fu">data.frame</span>(<span class="at">Coefficient =</span> coef, <span class="at">Value =</span> est_rmse)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>        }, beta0)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">.id =</span> <span class="st">"Algorithm"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Algorithm =</span> <span class="fu">ordered</span>(<span class="fu">as.factor</span>(Algorithm), <span class="fu">c</span>(<span class="st">"GWR"</span>, <span class="st">"MGWR"</span>, <span class="st">"HLM"</span>, <span class="st">"HGWR"</span>)),</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">Coefficient =</span> <span class="fu">ordered</span>(<span class="fu">as.factor</span>(Coefficient), coef_names)) <span class="sc">%&gt;%</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Coefficient, <span class="at">y =</span> Value, <span class="at">fill =</span> Algorithm)) <span class="sc">+</span> </span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">'identity'</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>()) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"RMSE"</span>) <span class="sc">+</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.6</span>), <span class="at">oob =</span> scales<span class="sc">::</span>squish, <span class="at">expand =</span> <span class="fu">expansion</span>()) <span class="sc">+</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale_x_discrete</span>(<span class="at">labels =</span> coef_name_labels[coef_names]) <span class="sc">+</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>From the perspective of estimation errors, HGWR significantly reduces the estimation error for local fixed effects. It can get over the affect of global fixed effects and random effects.</p>
</section>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<p>In this post we introduced how to calibrate an HGWR model using R package <strong>hgwrr</strong>. It is demonstrated that HGWR could properly estimate local fixed effects, global fixed effects, and random effects simultaneously. HGWR could usually successfully distinguish local fixed effects from other effect types. For local fixed effects, spatial heterogeneity is considered as with GWR; moreover, global fixed effects and random effects are estimated as accurately as when using HLM. Thus, HGWR can be regarded as a successful combination of GWR and HLM.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-BrunsdonFotheringham-1996" class="csl-entry" role="doc-biblioentry">
Brunsdon, Chris, A. Stewart Fotheringham, and Martin E. Charlton. 1996. <span>“Geographically <span>Weighted Regression</span>: <span>A Method</span> for <span>Exploring Spatial Nonstationarity</span>.”</span> <em>Geographical Analysis</em> 28 (4): 281–98. <a href="https://doi.org/10.1111/j.1538-4632.1996.tb00936.x">https://doi.org/10.1111/j.1538-4632.1996.tb00936.x</a>.
</div>
<div id="ref-FotheringhamYang-2017" class="csl-entry" role="doc-biblioentry">
Fotheringham, A. Stewart, Wenbai Yang, and Wei Kang. 2017. <span>“Multiscale <span>Geographically Weighted Regression</span> (<span>MGWR</span>).”</span> <em>Annals of the American Association of Geographers</em> 107 (6): 1247–65. <a href="https://doi.org/10.1080/24694452.2017.1352480">https://doi.org/10.1080/24694452.2017.1352480</a>.
</div>
<div id="ref-LuBrunsdon-2017" class="csl-entry" role="doc-biblioentry">
Lu, Binbin, Chris Brunsdon, Martin Charlton, and Paul Harris. 2017. <span>“Geographically Weighted Regression with Parameter-Specific Distance Metrics.”</span> <em>International Journal of Geographical Information Science</em> 31 (5): 982–98. <a href="https://doi.org/10.1080/13658816.2016.1263731">https://doi.org/10.1080/13658816.2016.1263731</a>.
</div>
<div id="ref-Raudenbush-1993" class="csl-entry" role="doc-biblioentry">
Raudenbush, Stephen W. 1993. <span>“Hierarchical <span>Linear Models</span> and <span>Experimental Design</span>.”</span> In <em>Applied Analysis of Variance in Behavioral Science</em>, 459–96. <span>L. K. Edwards</span>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<script>videojs(video_shortcode_videojs_video1);</script>



</body></html>